<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="概述 在此之前，我们看了setContentView()的源码，看了LayoutInflater.inflate()的源码，都没发现Activity绘制的触发代码，那触发Activity绘制的代码到底在哪里呢？在Activity里根本没找到，我想静静啊。\n"><title>Activity绘制系列：4. startActivity()</title>
<link rel=canonical href=https://pangfq.github.io/blog/p/android-view-source4/><link rel=stylesheet href=/blog/scss/style.min.663803bebe609202d5b39d848f2d7c2dc8b598a2d879efa079fa88893d29c49c.css><meta property='og:title' content="Activity绘制系列：4. startActivity()"><meta property='og:description' content="概述 在此之前，我们看了setContentView()的源码，看了LayoutInflater.inflate()的源码，都没发现Activity绘制的触发代码，那触发Activity绘制的代码到底在哪里呢？在Activity里根本没找到，我想静静啊。\n"><meta property='og:url' content='https://pangfq.github.io/blog/p/android-view-source4/'><meta property='og:site_name' content='Num21'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='View绘制'><meta property='article:published_time' content='2022-03-28T04:14:54-08:00'><meta property='article:modified_time' content='2022-03-28T04:14:54-08:00'><meta name=twitter:title content="Activity绘制系列：4. startActivity()"><meta name=twitter:description content="概述 在此之前，我们看了setContentView()的源码，看了LayoutInflater.inflate()的源码，都没发现Activity绘制的触发代码，那触发Activity绘制的代码到底在哪里呢？在Activity里根本没找到，我想静静啊。\n"><link rel="shortcut icon" href=/blog/favicon.ico></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/blog/><img src=/blog/img/avatar_hu_460221926010ae65.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/blog>Num21</a></h1><h2 class=site-description>但行好事，莫问前程</h2></div></header><ol class=menu-social><li><a href=mailto:a9qr21@gmail.com target=_blank title=Email rel=me><svg class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li><li><a href=https://github.com/pangfq target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/blog/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>首页</span></a></li><li><a href=/blog/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>归档</span></a></li><li><a href=/blog/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>搜索</span></a></li><li><a href=/blog/%E5%85%B3%E4%BA%8E/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>关于</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>暗色模式</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#概述>概述</a></li><li><a href=#源码>源码</a></li><li><a href=#总结>总结</a></li><li><a href=#关键词>关键词</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/blog/categories/android/>Android</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/blog/p/android-view-source4/>Activity绘制系列：4. startActivity()</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Mar 28, 2022</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>阅读时长: 10 分钟</time></div></footer></div></header><section class=article-content><h2 id=概述>概述</h2><p>在此之前，我们看了setContentView()的源码，看了LayoutInflater.inflate()的源码，都没发现Activity绘制的触发代码，那触发Activity绘制的代码到底在哪里呢？在Activity里根本没找到，我想静静啊。</p><p>我闭上了眼睛，放空大脑，就这样放着放着，突然灵光一现：既然不在Activity里，那是不是在Activity外呢？</p><p>因为Activity的生命周期都是由Framework层去调用的，其中生命周期函数onResume()表示Activity的可见性，Activity绘制出来才能可见，所以如果找到了Activity的onResume()函数的调用处，那是不是就找到了触发Activity绘制的代码了呢？</p><p>确定了思路，马上开始看源码，那从哪里看起呢？当然是启动Activity的startActivity()方法了。</p><h2 id=源码>源码</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>startActivity</span><span class=p>(</span><span class=n>Intent</span><span class=w> </span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=nd>@Nullable</span><span class=w> </span><span class=n>Bundle</span><span class=w> </span><span class=n>options</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>options</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          	</span><span class=c1>// 调用startActivityForResult()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>startActivityForResult</span><span class=p>(</span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=o>-</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>options</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>startActivityForResult</span><span class=p>(</span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=o>-</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>startActivityForResult</span><span class=p>(</span><span class=n>Intent</span><span class=w> </span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>requestCode</span><span class=p>,</span><span class=w> </span><span class=n>Bundle</span><span class=w> </span><span class=n>options</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mParent</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>options</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>transferSpringboardActivityOptions</span><span class=p>(</span><span class=n>options</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          	</span><span class=c1>// 调用Instrumentation的execStartActivity()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Instrumentation</span><span class=p>.</span><span class=na>ActivityResult</span><span class=w> </span><span class=n>ar</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mInstrumentation</span><span class=p>.</span><span class=na>execStartActivity</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>mMainThread</span><span class=p>.</span><span class=na>getApplicationThread</span><span class=p>(),</span><span class=w> </span><span class=n>mToken</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=n>requestCode</span><span class=p>,</span><span class=w> </span><span class=n>options</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          	</span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=n>ActivityResult</span><span class=w> </span><span class=nf>execStartActivity</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Context</span><span class=w> </span><span class=n>who</span><span class=p>,</span><span class=w> </span><span class=n>IBinder</span><span class=w> </span><span class=n>contextThread</span><span class=p>,</span><span class=w> </span><span class=n>IBinder</span><span class=w> </span><span class=n>token</span><span class=p>,</span><span class=w> </span><span class=n>Activity</span><span class=w> </span><span class=n>target</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Intent</span><span class=w> </span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>requestCode</span><span class=p>,</span><span class=w> </span><span class=n>Bundle</span><span class=w> </span><span class=n>options</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>IApplicationThread</span><span class=w> </span><span class=n>whoThread</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>IApplicationThread</span><span class=p>)</span><span class=w> </span><span class=n>contextThread</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>intent</span><span class=p>.</span><span class=na>migrateExtraStreamToClipData</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>intent</span><span class=p>.</span><span class=na>prepareToLeaveProcess</span><span class=p>(</span><span class=n>who</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          	</span><span class=c1>// 调用ActivityTaskManager.getService().startActivity()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ActivityTaskManager</span><span class=p>.</span><span class=na>getService</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>startActivity</span><span class=p>(</span><span class=n>whoThread</span><span class=p>,</span><span class=w> </span><span class=n>who</span><span class=p>.</span><span class=na>getBasePackageName</span><span class=p>(),</span><span class=w> </span><span class=n>intent</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>intent</span><span class=p>.</span><span class=na>resolveTypeIfNeeded</span><span class=p>(</span><span class=n>who</span><span class=p>.</span><span class=na>getContentResolver</span><span class=p>()),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>token</span><span class=p>,</span><span class=w> </span><span class=n>target</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>target</span><span class=p>.</span><span class=na>mEmbeddedID</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>requestCode</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>options</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>checkStartActivityResult</span><span class=p>(</span><span class=n>result</span><span class=p>,</span><span class=w> </span><span class=n>intent</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RemoteException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RuntimeException</span><span class=p>(</span><span class=s>&#34;Failure from system&#34;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// ActivityTaskManager.getService()会得到一个IActivityTaskManager实例</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>IActivityTaskManager</span><span class=w> </span><span class=nf>getService</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  			</span><span class=c1>// 这个实例是放在一个单例中的</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>IActivityTaskManagerSingleton</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 就是这个Singleton</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Singleton</span><span class=o>&lt;</span><span class=n>IActivityTaskManager</span><span class=o>&gt;</span><span class=w> </span><span class=n>IActivityTaskManagerSingleton</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>new</span><span class=w> </span><span class=n>Singleton</span><span class=o>&lt;</span><span class=n>IActivityTaskManager</span><span class=o>&gt;</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>protected</span><span class=w> </span><span class=n>IActivityTaskManager</span><span class=w> </span><span class=nf>create</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  	</span><span class=c1>// 此处创建IActivityTaskManager对象，并返回</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kd>final</span><span class=w> </span><span class=n>IBinder</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ServiceManager</span><span class=p>.</span><span class=na>getService</span><span class=p>(</span><span class=n>Context</span><span class=p>.</span><span class=na>ACTIVITY_TASK_SERVICE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  	</span><span class=c1>// 原来IActivityTaskManager是一个aidl，也就是Binder，所以startActivity()还是一个跨进程通信的过程</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=n>IActivityTaskManager</span><span class=p>.</span><span class=na>Stub</span><span class=p>.</span><span class=na>asInterface</span><span class=p>(</span><span class=n>b</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>};</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// ActivityTaskManagerService类实现了IActivityTaskManager.Stub接口，所以跨进程到ATMS中进行处理</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// ATMS所在进程叫SystemServer进程，这部分内容后续专门写文章讲，此处不再赘述</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ActivityTaskManagerService</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>IActivityTaskManager</span><span class=p>.</span><span class=na>Stub</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>startActivity</span><span class=p>(</span><span class=n>IApplicationThread</span><span class=w> </span><span class=n>caller</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>callingPackage</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Intent</span><span class=w> </span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>resolvedType</span><span class=p>,</span><span class=w> </span><span class=n>IBinder</span><span class=w> </span><span class=n>resultTo</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>resultWho</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>requestCode</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>startFlags</span><span class=p>,</span><span class=w> </span><span class=n>ProfilerInfo</span><span class=w> </span><span class=n>profilerInfo</span><span class=p>,</span><span class=w> </span><span class=n>Bundle</span><span class=w> </span><span class=n>bOptions</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      	</span><span class=c1>// 调用了startActivityAsUser()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>startActivityAsUser</span><span class=p>(</span><span class=n>caller</span><span class=p>,</span><span class=w> </span><span class=n>callingPackage</span><span class=p>,</span><span class=w> </span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=n>resolvedType</span><span class=p>,</span><span class=w> </span><span class=n>resultTo</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>resultWho</span><span class=p>,</span><span class=w> </span><span class=n>requestCode</span><span class=p>,</span><span class=w> </span><span class=n>startFlags</span><span class=p>,</span><span class=w> </span><span class=n>profilerInfo</span><span class=p>,</span><span class=w> </span><span class=n>bOptions</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>UserHandle</span><span class=p>.</span><span class=na>getCallingUserId</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kt>int</span><span class=w> </span><span class=nf>startActivityAsUser</span><span class=p>(</span><span class=n>IApplicationThread</span><span class=w> </span><span class=n>caller</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>callingPackage</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Intent</span><span class=w> </span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>resolvedType</span><span class=p>,</span><span class=w> </span><span class=n>IBinder</span><span class=w> </span><span class=n>resultTo</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>resultWho</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>requestCode</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>startFlags</span><span class=p>,</span><span class=w> </span><span class=n>ProfilerInfo</span><span class=w> </span><span class=n>profilerInfo</span><span class=p>,</span><span class=w> </span><span class=n>Bundle</span><span class=w> </span><span class=n>bOptions</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>userId</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>boolean</span><span class=w> </span><span class=n>validateIncomingUser</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>enforceNotIsolatedCaller</span><span class=p>(</span><span class=s>&#34;startActivityAsUser&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>userId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getActivityStartController</span><span class=p>().</span><span class=na>checkTargetUser</span><span class=p>(</span><span class=n>userId</span><span class=p>,</span><span class=w> </span><span class=n>validateIncomingUser</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Binder</span><span class=p>.</span><span class=na>getCallingPid</span><span class=p>(),</span><span class=w> </span><span class=n>Binder</span><span class=p>.</span><span class=na>getCallingUid</span><span class=p>(),</span><span class=w> </span><span class=s>&#34;startActivityAsUser&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=c1>// 又调用了ActivityStarter.execute()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>getActivityStartController</span><span class=p>().</span><span class=na>obtainStarter</span><span class=p>(</span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=s>&#34;startActivityAsUser&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>setCaller</span><span class=p>(</span><span class=n>caller</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>setCallingPackage</span><span class=p>(</span><span class=n>callingPackage</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>setResolvedType</span><span class=p>(</span><span class=n>resolvedType</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>setResultTo</span><span class=p>(</span><span class=n>resultTo</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>setResultWho</span><span class=p>(</span><span class=n>resultWho</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>setRequestCode</span><span class=p>(</span><span class=n>requestCode</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>setStartFlags</span><span class=p>(</span><span class=n>startFlags</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>setProfilerInfo</span><span class=p>(</span><span class=n>profilerInfo</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>setActivityOptions</span><span class=p>(</span><span class=n>bOptions</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>setMayWait</span><span class=p>(</span><span class=n>userId</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>execute</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>ActivityStarter</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=kt>int</span><span class=w> </span><span class=nf>execute</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mRequest</span><span class=p>.</span><span class=na>mayWait</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>startActivityMayWait</span><span class=p>(</span><span class=n>mRequest</span><span class=p>.</span><span class=na>caller</span><span class=p>,</span><span class=w> </span><span class=n>mRequest</span><span class=p>.</span><span class=na>callingUid</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mRequest</span><span class=p>.</span><span class=na>callingPackage</span><span class=p>,</span><span class=w> </span><span class=n>mRequest</span><span class=p>.</span><span class=na>realCallingPid</span><span class=p>,</span><span class=w> </span><span class=n>mRequest</span><span class=p>.</span><span class=na>realCallingUid</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mRequest</span><span class=p>.</span><span class=na>intent</span><span class=p>,</span><span class=w> </span><span class=n>mRequest</span><span class=p>.</span><span class=na>resolvedType</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mRequest</span><span class=p>.</span><span class=na>voiceSession</span><span class=p>,</span><span class=w> </span><span class=n>mRequest</span><span class=p>.</span><span class=na>voiceInteractor</span><span class=p>,</span><span class=w> </span><span class=n>mRequest</span><span class=p>.</span><span class=na>resultTo</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mRequest</span><span class=p>.</span><span class=na>resultWho</span><span class=p>,</span><span class=w> </span><span class=n>mRequest</span><span class=p>.</span><span class=na>requestCode</span><span class=p>,</span><span class=w> </span><span class=n>mRequest</span><span class=p>.</span><span class=na>startFlags</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mRequest</span><span class=p>.</span><span class=na>profilerInfo</span><span class=p>,</span><span class=w> </span><span class=n>mRequest</span><span class=p>.</span><span class=na>waitResult</span><span class=p>,</span><span class=w> </span><span class=n>mRequest</span><span class=p>.</span><span class=na>globalConfig</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mRequest</span><span class=p>.</span><span class=na>activityOptions</span><span class=p>,</span><span class=w> </span><span class=n>mRequest</span><span class=p>.</span><span class=na>ignoreTargetSecurity</span><span class=p>,</span><span class=w> </span><span class=n>mRequest</span><span class=p>.</span><span class=na>userId</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mRequest</span><span class=p>.</span><span class=na>inTask</span><span class=p>,</span><span class=w> </span><span class=n>mRequest</span><span class=p>.</span><span class=na>reason</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mRequest</span><span class=p>.</span><span class=na>allowPendingRemoteAnimationRegistryLookup</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mRequest</span><span class=p>.</span><span class=na>originatingPendingIntent</span><span class=p>,</span><span class=w> </span><span class=n>mRequest</span><span class=p>.</span><span class=na>allowBackgroundActivityStart</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              	</span><span class=c1>// 调用startActivity()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>startActivity</span><span class=p>(</span><span class=n>mRequest</span><span class=p>.</span><span class=na>caller</span><span class=p>,</span><span class=w> </span><span class=n>mRequest</span><span class=p>.</span><span class=na>intent</span><span class=p>,</span><span class=w> </span><span class=n>mRequest</span><span class=p>.</span><span class=na>ephemeralIntent</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mRequest</span><span class=p>.</span><span class=na>resolvedType</span><span class=p>,</span><span class=w> </span><span class=n>mRequest</span><span class=p>.</span><span class=na>activityInfo</span><span class=p>,</span><span class=w> </span><span class=n>mRequest</span><span class=p>.</span><span class=na>resolveInfo</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mRequest</span><span class=p>.</span><span class=na>voiceSession</span><span class=p>,</span><span class=w> </span><span class=n>mRequest</span><span class=p>.</span><span class=na>voiceInteractor</span><span class=p>,</span><span class=w> </span><span class=n>mRequest</span><span class=p>.</span><span class=na>resultTo</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mRequest</span><span class=p>.</span><span class=na>resultWho</span><span class=p>,</span><span class=w> </span><span class=n>mRequest</span><span class=p>.</span><span class=na>requestCode</span><span class=p>,</span><span class=w> </span><span class=n>mRequest</span><span class=p>.</span><span class=na>callingPid</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mRequest</span><span class=p>.</span><span class=na>callingUid</span><span class=p>,</span><span class=w> </span><span class=n>mRequest</span><span class=p>.</span><span class=na>callingPackage</span><span class=p>,</span><span class=w> </span><span class=n>mRequest</span><span class=p>.</span><span class=na>realCallingPid</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mRequest</span><span class=p>.</span><span class=na>realCallingUid</span><span class=p>,</span><span class=w> </span><span class=n>mRequest</span><span class=p>.</span><span class=na>startFlags</span><span class=p>,</span><span class=w> </span><span class=n>mRequest</span><span class=p>.</span><span class=na>activityOptions</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mRequest</span><span class=p>.</span><span class=na>ignoreTargetSecurity</span><span class=p>,</span><span class=w> </span><span class=n>mRequest</span><span class=p>.</span><span class=na>componentSpecified</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mRequest</span><span class=p>.</span><span class=na>outActivity</span><span class=p>,</span><span class=w> </span><span class=n>mRequest</span><span class=p>.</span><span class=na>inTask</span><span class=p>,</span><span class=w> </span><span class=n>mRequest</span><span class=p>.</span><span class=na>reason</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mRequest</span><span class=p>.</span><span class=na>allowPendingRemoteAnimationRegistryLookup</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mRequest</span><span class=p>.</span><span class=na>originatingPendingIntent</span><span class=p>,</span><span class=w> </span><span class=n>mRequest</span><span class=p>.</span><span class=na>allowBackgroundActivityStart</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>onExecutionComplete</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c1>// 参数真的多啊</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>startActivity</span><span class=p>(</span><span class=kd>final</span><span class=w> </span><span class=n>ActivityRecord</span><span class=w> </span><span class=n>r</span><span class=p>,</span><span class=w> </span><span class=n>ActivityRecord</span><span class=w> </span><span class=n>sourceRecord</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>IVoiceInteractionSession</span><span class=w> </span><span class=n>voiceSession</span><span class=p>,</span><span class=w> </span><span class=n>IVoiceInteractor</span><span class=w> </span><span class=n>voiceInteractor</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>int</span><span class=w> </span><span class=n>startFlags</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>doResume</span><span class=p>,</span><span class=w> </span><span class=n>ActivityOptions</span><span class=w> </span><span class=n>options</span><span class=p>,</span><span class=w> </span><span class=n>TaskRecord</span><span class=w> </span><span class=n>inTask</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>ActivityRecord</span><span class=o>[]</span><span class=w> </span><span class=n>outActivity</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>restrictedBgActivity</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>START_CANCELED</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>ActivityStack</span><span class=w> </span><span class=n>startedActivityStack</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mService</span><span class=p>.</span><span class=na>mWindowManager</span><span class=p>.</span><span class=na>deferSurfaceLayout</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          	</span><span class=c1>// 调用startActivityUnchecked()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>startActivityUnchecked</span><span class=p>(</span><span class=n>r</span><span class=p>,</span><span class=w> </span><span class=n>sourceRecord</span><span class=p>,</span><span class=w> </span><span class=n>voiceSession</span><span class=p>,</span><span class=w> </span><span class=n>voiceInteractor</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>startFlags</span><span class=p>,</span><span class=w> </span><span class=n>doResume</span><span class=p>,</span><span class=w> </span><span class=n>options</span><span class=p>,</span><span class=w> </span><span class=n>inTask</span><span class=p>,</span><span class=w> </span><span class=n>outActivity</span><span class=p>,</span><span class=w> </span><span class=n>restrictedBgActivity</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    		</span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>startActivityUnchecked</span><span class=p>(</span><span class=kd>final</span><span class=w> </span><span class=n>ActivityRecord</span><span class=w> </span><span class=n>r</span><span class=p>,</span><span class=w> </span><span class=n>ActivityRecord</span><span class=w> </span><span class=n>sourceRecord</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>IVoiceInteractionSession</span><span class=w> </span><span class=n>voiceSession</span><span class=p>,</span><span class=w> </span><span class=n>IVoiceInteractor</span><span class=w> </span><span class=n>voiceInteractor</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>startFlags</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>doResume</span><span class=p>,</span><span class=w> </span><span class=n>ActivityOptions</span><span class=w> </span><span class=n>options</span><span class=p>,</span><span class=w> </span><span class=n>TaskRecord</span><span class=w> </span><span class=n>inTask</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ActivityRecord</span><span class=o>[]</span><span class=w> </span><span class=n>outActivity</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>restrictedBgActivity</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    	</span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mDoResume</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 调用RootActivityContainer的resumeFocusedStacksTopActivities()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      	</span><span class=n>mRootActivityContainer</span><span class=p>.</span><span class=na>resumeFocusedStacksTopActivities</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    	</span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>RootActivityContainer</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>ConfigurationContainer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>implements</span><span class=w> </span><span class=n>DisplayManager</span><span class=p>.</span><span class=na>DisplayListener</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=kt>boolean</span><span class=w> </span><span class=nf>resumeFocusedStacksTopActivities</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ActivityStack</span><span class=w> </span><span class=n>targetStack</span><span class=p>,</span><span class=w> </span><span class=n>ActivityRecord</span><span class=w> </span><span class=n>target</span><span class=p>,</span><span class=w> </span><span class=n>ActivityOptions</span><span class=w> </span><span class=n>targetOptions</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>mStackSupervisor</span><span class=p>.</span><span class=na>readyToResume</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>targetStack</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>(</span><span class=n>targetStack</span><span class=p>.</span><span class=na>isTopStackOnDisplay</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>||</span><span class=w> </span><span class=n>getTopDisplayFocusedStack</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>targetStack</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          	</span><span class=c1>// 调用ActivityStack的resumeTopActivityUncheckedLocked()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>targetStack</span><span class=p>.</span><span class=na>resumeTopActivityUncheckedLocked</span><span class=p>(</span><span class=n>target</span><span class=p>,</span><span class=w> </span><span class=n>targetOptions</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>ActivityStack</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>ConfigurationContainer</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=kd>private</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>resumeTopActivityInnerLocked</span><span class=p>(</span><span class=n>ActivityRecord</span><span class=w> </span><span class=n>prev</span><span class=p>,</span><span class=w> </span><span class=n>ActivityOptions</span><span class=w> </span><span class=n>options</span><span class=p>)</span><span class=w> 	</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    		</span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mStackSupervisor</span><span class=p>.</span><span class=na>startSpecificActivityLocked</span><span class=p>(</span><span class=n>next</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    		</span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ActivityStackSupervisor</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>RecentTasks</span><span class=p>.</span><span class=na>Callbacks</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=kt>void</span><span class=w> </span><span class=nf>startSpecificActivityLocked</span><span class=p>(</span><span class=n>ActivityRecord</span><span class=w> </span><span class=n>r</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>andResume</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>checkConfig</span><span class=p>)</span><span class=w>	</span><span class=p>{</span><span class=w>				
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>realStartActivityLocked</span><span class=p>(</span><span class=n>r</span><span class=p>,</span><span class=w> </span><span class=n>wpc</span><span class=p>,</span><span class=w> </span><span class=n>andResume</span><span class=p>,</span><span class=w> </span><span class=n>checkConfig</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kt>boolean</span><span class=w> </span><span class=nf>realStartActivityLocked</span><span class=p>(</span><span class=n>ActivityRecord</span><span class=w> </span><span class=n>r</span><span class=p>,</span><span class=w> </span><span class=n>WindowProcessController</span><span class=w> </span><span class=n>proc</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>boolean</span><span class=w> </span><span class=n>andResume</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>checkConfig</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>RemoteException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    		</span><span class=c1>// 封装成ClientTransaction</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	      </span><span class=n>mService</span><span class=p>.</span><span class=na>getLifecycleManager</span><span class=p>().</span><span class=na>scheduleTransaction</span><span class=p>(</span><span class=n>clientTransaction</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>ClientLifecycleManager</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=kt>void</span><span class=w> </span><span class=nf>scheduleTransaction</span><span class=p>(</span><span class=n>ClientTransaction</span><span class=w> </span><span class=n>transaction</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>RemoteException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      	</span><span class=c1>// IApplicationThread是客户端的Binder，ATMS就是通过该Binder最终回到APP进程的</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>IApplicationThread</span><span class=w> </span><span class=n>client</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>transaction</span><span class=p>.</span><span class=na>getClient</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>transaction</span><span class=p>.</span><span class=na>schedule</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=n>client</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>Binder</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          	</span><span class=c1>// the transaction is executed on client in ActivityThread.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          	</span><span class=c1>// 这个Transaction是被客户端的ActivityThread执行的</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>transaction</span><span class=p>.</span><span class=na>recycle</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>ActivityThread</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>ClientTransactionHandler</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c1>// ApplicationThread继承了IApplicationThread.Stub，所以是一个主进程的Binder</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c1>// 是ActivityThread的内部类</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>class</span> <span class=nc>ApplicationThread</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>IApplicationThread</span><span class=p>.</span><span class=na>Stub</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    		</span><span class=c1>// ATMS会通过binder回调该方法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>scheduleApplicationInfoChanged</span><span class=p>(</span><span class=n>ApplicationInfo</span><span class=w> </span><span class=n>ai</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mH</span><span class=p>.</span><span class=na>removeMessages</span><span class=p>(</span><span class=n>H</span><span class=p>.</span><span class=na>APPLICATION_INFO_CHANGED</span><span class=p>,</span><span class=w> </span><span class=n>ai</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          	</span><span class=c1>// 通过主线程的Handler回到主线程</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sendMessage</span><span class=p>(</span><span class=n>H</span><span class=p>.</span><span class=na>APPLICATION_INFO_CHANGED</span><span class=p>,</span><span class=w> </span><span class=n>ai</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    		</span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=n>Activity</span><span class=w> </span><span class=nf>performLaunchActivity</span><span class=p>(</span><span class=n>ActivityClientRecord</span><span class=w> </span><span class=n>r</span><span class=p>,</span><span class=w> </span><span class=n>Intent</span><span class=w> </span><span class=n>customIntent</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ContextImpl</span><span class=w> </span><span class=n>appContext</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>createBaseContextForActivity</span><span class=p>(</span><span class=n>r</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Activity</span><span class=w> </span><span class=n>activity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>ClassLoader</span><span class=w> </span><span class=n>cl</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>appContext</span><span class=p>.</span><span class=na>getClassLoader</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          	</span><span class=c1>// 调用Instrumentation去创建Activity</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>activity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mInstrumentation</span><span class=p>.</span><span class=na>newActivity</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>cl</span><span class=p>,</span><span class=w> </span><span class=n>component</span><span class=p>.</span><span class=na>getClassName</span><span class=p>(),</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>intent</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>StrictMode</span><span class=p>.</span><span class=na>incrementExpectedActivityCount</span><span class=p>(</span><span class=n>activity</span><span class=p>.</span><span class=na>getClass</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>r</span><span class=p>.</span><span class=na>intent</span><span class=p>.</span><span class=na>setExtrasClassLoader</span><span class=p>(</span><span class=n>cl</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>r</span><span class=p>.</span><span class=na>intent</span><span class=p>.</span><span class=na>prepareToEnterProcess</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>state</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>r</span><span class=p>.</span><span class=na>state</span><span class=p>.</span><span class=na>setClassLoader</span><span class=p>(</span><span class=n>cl</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>mInstrumentation</span><span class=p>.</span><span class=na>onException</span><span class=p>(</span><span class=n>activity</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RuntimeException</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=s>&#34;Unable to instantiate activity &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>component</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>+</span><span class=w> </span><span class=s>&#34;: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>toString</span><span class=p>(),</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    	</span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    	</span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>isPersistable</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mInstrumentation</span><span class=p>.</span><span class=na>callActivityOnCreate</span><span class=p>(</span><span class=n>activity</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>state</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>persistentState</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        						</span><span class=c1>// 创建完Activity后，还是通过Instrumentation来调用Activity的生命周期</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mInstrumentation</span><span class=p>.</span><span class=na>callActivityOnCreate</span><span class=p>(</span><span class=n>activity</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>state</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>handleResumeActivity</span><span class=p>(</span><span class=n>IBinder</span><span class=w> </span><span class=n>token</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>finalStateRequest</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>isForward</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>reason</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     		</span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 调用Activity的onResume()生命周期方法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>ActivityClientRecord</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>performResumeActivity</span><span class=p>(</span><span class=n>token</span><span class=p>,</span><span class=w> </span><span class=n>finalStateRequest</span><span class=p>,</span><span class=w> </span><span class=n>reason</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>Activity</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>activity</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       	</span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>window</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>a</span><span class=p>.</span><span class=na>mFinished</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>willBeVisible</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          	</span><span class=c1>// 取出Activity的Window</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>r</span><span class=p>.</span><span class=na>window</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>activity</span><span class=p>.</span><span class=na>getWindow</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          	</span><span class=c1>// 取出Activity的DecorView</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>View</span><span class=w> </span><span class=n>decor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>window</span><span class=p>.</span><span class=na>getDecorView</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>decor</span><span class=p>.</span><span class=na>setVisibility</span><span class=p>(</span><span class=n>View</span><span class=p>.</span><span class=na>INVISIBLE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          	</span><span class=c1>// 取出Activity的WindowManager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ViewManager</span><span class=w> </span><span class=n>wm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a</span><span class=p>.</span><span class=na>getWindowManager</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=w> </span><span class=n>l</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>window</span><span class=p>.</span><span class=na>getAttributes</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>a</span><span class=p>.</span><span class=na>mDecor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>decor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>a</span><span class=p>.</span><span class=na>mVisibleFromClient</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>a</span><span class=p>.</span><span class=na>mWindowAdded</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>a</span><span class=p>.</span><span class=na>mWindowAdded</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>										
</span></span></span><span class=line><span class=cl><span class=w>                  	</span><span class=c1>// 调用WindowManager的addView()，将DecorView添加到Window中</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  	</span><span class=c1>// 内部会调用WindowManagerGlobal的addView()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  	</span><span class=c1>// 再继续调用ViewRootImpl的setView()触发DecorView的绘制</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  	</span><span class=c1>// 所以此处就是就是Activity绘制的开始</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>wm</span><span class=p>.</span><span class=na>addView</span><span class=p>(</span><span class=n>decor</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>a</span><span class=p>.</span><span class=na>onWindowAttributesChanged</span><span class=p>(</span><span class=n>l</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>willBeVisible</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>localLOGV</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Launch &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; mStartedActivity set&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>r</span><span class=p>.</span><span class=na>hideForNow</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>r</span><span class=p>.</span><span class=na>activity</span><span class=p>.</span><span class=na>mFinished</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>willBeVisible</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>activity</span><span class=p>.</span><span class=na>mDecor</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>r</span><span class=p>.</span><span class=na>hideForNow</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// ... </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=w> </span><span class=n>l</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>window</span><span class=p>.</span><span class=na>getAttributes</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>l</span><span class=p>.</span><span class=na>softInputMode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>&amp;</span><span class=w> </span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>.</span><span class=na>SOFT_INPUT_IS_FORWARD_NAVIGATION</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>!=</span><span class=w> </span><span class=n>forwardBit</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>l</span><span class=p>.</span><span class=na>softInputMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>l</span><span class=p>.</span><span class=na>softInputMode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>&amp;</span><span class=w> </span><span class=p>(</span><span class=o>~</span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>.</span><span class=na>SOFT_INPUT_IS_FORWARD_NAVIGATION</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>|</span><span class=w> </span><span class=n>forwardBit</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>activity</span><span class=p>.</span><span class=na>mVisibleFromClient</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>ViewManager</span><span class=w> </span><span class=n>wm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a</span><span class=p>.</span><span class=na>getWindowManager</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>View</span><span class=w> </span><span class=n>decor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>window</span><span class=p>.</span><span class=na>getDecorView</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  	</span><span class=c1>// 此处也会触发DecorView的绘制</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  	</span><span class=c1>// WindowManager实现了ViewManager接口，该接口中有三个方法:addView()、updateViewLayout()、removeView()，分别对应View的添加、更新、删除操作，所以添加和更新一定会触发View的绘制</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>wm</span><span class=p>.</span><span class=na>updateViewLayout</span><span class=p>(</span><span class=n>decor</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          	</span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Looper</span><span class=p>.</span><span class=na>myQueue</span><span class=p>().</span><span class=na>addIdleHandler</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Idler</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// Activity的生命周期都是通过Instrumentation调用的</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Instrumentation</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c1>// 创建Activity</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=kd>public</span><span class=w> </span><span class=n>Activity</span><span class=w> </span><span class=nf>newActivity</span><span class=p>(</span><span class=n>ClassLoader</span><span class=w> </span><span class=n>cl</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>className</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Intent</span><span class=w> </span><span class=n>intent</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>throws</span><span class=w> </span><span class=n>InstantiationException</span><span class=p>,</span><span class=w> </span><span class=n>IllegalAccessException</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ClassNotFoundException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>pkg</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>intent</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>intent</span><span class=p>.</span><span class=na>getComponent</span><span class=p>()</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>?</span><span class=w> </span><span class=n>intent</span><span class=p>.</span><span class=na>getComponent</span><span class=p>().</span><span class=na>getPackageName</span><span class=p>()</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=c1>// 调用了一个工厂去创建Activity</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>getFactory</span><span class=p>(</span><span class=n>pkg</span><span class=p>).</span><span class=na>instantiateActivity</span><span class=p>(</span><span class=n>cl</span><span class=p>,</span><span class=w> </span><span class=n>className</span><span class=p>,</span><span class=w> </span><span class=n>intent</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c1>// 调用Activity的生命周期方法onResume()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>callActivityOnResume</span><span class=p>(</span><span class=n>Activity</span><span class=w> </span><span class=n>activity</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>activity</span><span class=p>.</span><span class=na>mResumed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>activity</span><span class=p>.</span><span class=na>onResume</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mActivityMonitors</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>mSync</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>N</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mActivityMonitors</span><span class=p>.</span><span class=na>size</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=o>=</span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>&lt;</span><span class=n>N</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kd>final</span><span class=w> </span><span class=n>ActivityMonitor</span><span class=w> </span><span class=n>am</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mActivityMonitors</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>am</span><span class=p>.</span><span class=na>match</span><span class=p>(</span><span class=n>activity</span><span class=p>,</span><span class=w> </span><span class=n>activity</span><span class=p>,</span><span class=w> </span><span class=n>activity</span><span class=p>.</span><span class=na>getIntent</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>callActivityOnCreate</span><span class=p>(</span><span class=n>Activity</span><span class=w> </span><span class=n>activity</span><span class=p>){</span><span class=c1>//...}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>callActivityOnDestroy</span><span class=p>(</span><span class=n>Activity</span><span class=w> </span><span class=n>activity</span><span class=p>){</span><span class=c1>//...}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>callActivityOnStart</span><span class=p>(</span><span class=n>Activity</span><span class=w> </span><span class=n>activity</span><span class=p>){</span><span class=c1>//...}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>AppComponentFactory</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=kd>public</span><span class=w> </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Activity</span><span class=w> </span><span class=nf>instantiateActivity</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>ClassLoader</span><span class=w> </span><span class=n>cl</span><span class=p>,</span><span class=w> </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>String</span><span class=w> 	</span><span class=n>className</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nd>@Nullable</span><span class=w> </span><span class=n>Intent</span><span class=w> </span><span class=n>intent</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>throws</span><span class=w> </span><span class=n>InstantiationException</span><span class=p>,</span><span class=w> </span><span class=n>IllegalAccessException</span><span class=p>,</span><span class=w> </span><span class=n>ClassNotFoundException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    		</span><span class=c1>// 原来最后是通过一个ClassLoader创建出的Activity，这个ClassLoader是从Context获取的</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=n>Activity</span><span class=p>)</span><span class=w> </span><span class=n>cl</span><span class=p>.</span><span class=na>loadClass</span><span class=p>(</span><span class=n>className</span><span class=p>).</span><span class=na>newInstance</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>WindowManagerGlobal</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  	</span><span class=c1>// 是一个单例，一个进程就只有一个</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>WindowManagerGlobal</span><span class=w> </span><span class=nf>getInstance</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>WindowManagerGlobal</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>sDefaultWindowManager</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>sDefaultWindowManager</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>WindowManagerGlobal</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>sDefaultWindowManager</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  	</span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>addView</span><span class=p>(</span><span class=n>View</span><span class=w> </span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>ViewGroup</span><span class=p>.</span><span class=na>LayoutParams</span><span class=w> </span><span class=n>params</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Display</span><span class=w> </span><span class=n>display</span><span class=p>,</span><span class=w> </span><span class=n>Window</span><span class=w> </span><span class=n>parentWindow</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ViewRootImpl</span><span class=w> </span><span class=n>root</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>View</span><span class=w> </span><span class=n>panelParentView</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>mLock</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          	</span><span class=c1>// 创建ViewRootImpl对象，该对象会持有DecorView，跟它的名字一样，ViewRoot，视图根</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          	</span><span class=c1>// WindowManager通过ViewRootImpl来管理View，就跟访问链表要先通过head指针一样</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>root</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ViewRootImpl</span><span class=p>(</span><span class=n>view</span><span class=p>.</span><span class=na>getContext</span><span class=p>(),</span><span class=w> </span><span class=n>display</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>view</span><span class=p>.</span><span class=na>setLayoutParams</span><span class=p>(</span><span class=n>wparams</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mViews</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>view</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mRoots</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>root</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mParams</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>wparams</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              	</span><span class=c1>// 进入到ViewRootImpl中的setView()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>root</span><span class=p>.</span><span class=na>setView</span><span class=p>(</span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>wparams</span><span class=p>,</span><span class=w> </span><span class=n>panelParentView</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RuntimeException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// BadTokenException or InvalidDisplayException, clean up.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>index</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>removeViewLocked</span><span class=p>(</span><span class=n>index</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=n>e</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>ViewRootImpl</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>ViewParent</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>View</span><span class=p>.</span><span class=na>AttachInfo</span><span class=p>.</span><span class=na>Callbacks</span><span class=p>,</span><span class=w> </span><span class=n>ThreadedRenderer</span><span class=p>.</span><span class=na>DrawCallbacks</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setView</span><span class=p>(</span><span class=n>View</span><span class=w> </span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=w> </span><span class=n>attrs</span><span class=p>,</span><span class=w> </span><span class=n>View</span><span class=w> </span><span class=n>panelParentView</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          			</span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            		</span><span class=n>requestLayout</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            		</span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>requestLayout</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            	</span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	            </span><span class=n>scheduleTraversals</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            	</span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    			
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=kt>void</span><span class=w> </span><span class=nf>scheduleTraversals</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        			</span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>mTraversalScheduled</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            			</span><span class=n>mTraversalScheduled</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                	</span><span class=c1>// 因为涉及到View，所以要通过Handler提交到主线程处理</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                	</span><span class=c1>// 这里就有意思了，发现先提了一个同步屏障消息</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                	</span><span class=c1>// 同步屏障消息的作用是屏蔽掉当前MessageQueue中的同步消息，优先让异步消息执行</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                	</span><span class=c1>// 而绘制View的操作会放到Runnable中，并将Message设置成异步消息，这样绘制View就会优先得到处理</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            			</span><span class=n>mTraversalBarrier</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mHandler</span><span class=p>.</span><span class=na>getLooper</span><span class=p>().</span><span class=na>getQueue</span><span class=p>().</span><span class=na>postSyncBarrier</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            			</span><span class=n>mChoreographer</span><span class=p>.</span><span class=na>postCallback</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Choreographer</span><span class=p>.</span><span class=na>CALLBACK_TRAVERSAL</span><span class=p>,</span><span class=w> </span><span class=n>mTraversalRunnable</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>TraversalRunnable</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Runnable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     			   </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      			      </span><span class=n>doTraversal</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        			</span><span class=p>}</span><span class=w>	
</span></span></span><span class=line><span class=cl><span class=w>    			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=kt>void</span><span class=w> </span><span class=nf>doTraversal</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            	</span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mTraversalScheduled</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          	    </span><span class=n>mTraversalScheduled</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 开始执行了，就把同步屏障移除吧</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          	    </span><span class=n>mHandler</span><span class=p>.</span><span class=na>getLooper</span><span class=p>().</span><span class=na>getQueue</span><span class=p>().</span><span class=na>removeSyncBarrier</span><span class=p>(</span><span class=n>mTraversalBarrier</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          	    </span><span class=c1>// 执行遍历，为啥要叫遍历呢？是因为DecorView本身就是一个View树，所以它的绘制就是一个深度优先遍历的过程，所以就叫Tralversals</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>performTraversals</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>performTraversals</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            	</span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          		</span><span class=n>performMeasure</span><span class=p>(</span><span class=n>childWidthMeasureSpec</span><span class=p>,</span><span class=w> </span><span class=n>childHeightMeasureSpec</span><span class=p>);</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>            	</span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            	</span><span class=n>performLayout</span><span class=p>(</span><span class=n>lp</span><span class=p>,</span><span class=w> </span><span class=n>mWidth</span><span class=p>,</span><span class=w> </span><span class=n>mHeight</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            	</span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            	</span><span class=n>performDraw</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            	</span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>performMeasure</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>childWidthMeasureSpec</span><span class=p>,</span><span class=kt>int</span><span class=w> </span><span class=n>childHeightMeasureSpec</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          		</span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mView</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              		</span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          		</span><span class=n>Trace</span><span class=p>.</span><span class=na>traceBegin</span><span class=p>(</span><span class=n>Trace</span><span class=p>.</span><span class=na>TRACE_TAG_VIEW</span><span class=p>,</span><span class=w> </span><span class=s>&#34;measure&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          		</span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                	</span><span class=c1>// 调用DecorView的measure()开始进入测量环节</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              		</span><span class=n>mView</span><span class=p>.</span><span class=na>measure</span><span class=p>(</span><span class=n>childWidthMeasureSpec</span><span class=p>,</span><span class=w> </span><span class=n>childHeightMeasureSpec</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          		</span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              		</span><span class=n>Trace</span><span class=p>.</span><span class=na>traceEnd</span><span class=p>(</span><span class=n>Trace</span><span class=p>.</span><span class=na>TRACE_TAG_VIEW</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=c1>// performLayout()和performDraw()就不贴出来了</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>源码跟踪到此结束。</p><h2 id=总结>总结</h2><p>我们最终通过Activity的startActivity()找到了Activity绘制的触发点，还顺便了解了Activity的启动流程，这一趟没白来，下面简要总结下整个流程：</p><ol><li>Activity的startActivity()开始</li><li>Instrumentation调用Binder对象IActivityTaskManager跨进程进入到ActivityTaskManagerService(ATMS)中</li><li>经过ATMS的一系列处理，包括Activity是否在Manifest.xml中注册过等等</li><li>ATMS处理完，会调用Binder对象IApplicationThread跨进程回到APP进程ActivityThread中</li><li>ActivityThread会调用主线程的Handler回调到主线程</li><li>ActivityThread会调用performCreateActivity()，由Instrumentation通过ClassLoader创建出Activity对象，并调用Activity的onCreate()</li><li>ActivityThread会调用handleResumeActivity()，同样通过Instrumentation调用Activity的onResume()；并通过Activity的WindowManager调用addView(mDecorView)将Activity的DecorView添加进来</li><li>WindowManager内部通过桥梁模式继续调用WindowManagerGlobal调用addView()</li><li>WindowManagerGlobal的addView()内部会创建ViewRootImpl并持有DecorView，然后调用ViewRootImpl的setView(mDecorView)</li><li>ViewRootImpl的setView()内部会先通过Handler发送一个同步屏障消息，然后将触发DecorView绘制的操作放到一个异步消息中，来保证View绘制优先处理。</li></ol><h2 id=关键词>关键词</h2><ul><li>Instrumentation</li><li>IActivityTaskManager</li><li>ActivityTaskManagerService</li><li>IApplicationThread</li><li>ActivityThread</li><li>WindowManager extends ViewManager</li><li>WindowManagerGlobal</li><li>ViewRootImpl</li></ul></section><footer class=article-footer><section class=article-tags><a href=/blog/tags/view%E7%BB%98%E5%88%B6/>View绘制</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/blog/p/android-view-source1/><div class=article-details><h2 class=article-title>Activity绘制系列：1. setContentView()</h2></div></a></article><article><a href=/blog/p/android-view-source10/><div class=article-details><h2 class=article-title>Activity绘制系列：10. postInvalidate()</h2></div></a></article><article><a href=/blog/p/android-view-source2/><div class=article-details><h2 class=article-title>Activity绘制系列：2. findViewById()</h2></div></a></article><article><a href=/blog/p/android-view-source3/><div class=article-details><h2 class=article-title>Activity绘制系列：3. LayoutInflater.inflate()</h2></div></a></article><article><a href=/blog/p/android-view-source5/><div class=article-details><h2 class=article-title>Activity绘制系列：5. onMeasure()</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//pangfq.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2014 -
2025 Num21</section><section class=powerby>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 构建<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/blog/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>