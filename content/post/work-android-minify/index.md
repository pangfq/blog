---
title: APK瘦身
description: 
slug: work-android-minify
date: 2022-03-28T04:14:54-08:00
categories:
    - Android
tags:
    - apk
---

## 概述

APK瘦身，主要分为两个方面：代码和资源。

## 代码

代码方面的精简，需要具体代码具体分析，而且精简效果不明显，目前总结如下：

1. 移除未使用的代码，比如：
   - 多余的import语句
   - 没有被调用到的方法或属性
2. 开启代码混淆；
3. 实体类别用set、get方法，直接用public修饰属性；
4. 合并一些功能相同的类，比如：
   - 有很多工具类中的功能有重叠等
5. 通过代码重构解决代码冗余问题，比如：
   - 使用三目运算符代替if-else
   - 减少临时变量的定义

## 资源

资源方面的精简，涉及的东西较多，而且精简效果很明显，如下：

1. 图片资源的精简，比如：

   - 压缩质量，使用TinyPng、智图等工具对图片进行适当压缩；
   - 选择合适的图片格式，比如：没有透明通道的就用JPEG格式、简单的图标就用SVG格式、也可以用webP代替JPEG、PNG等；
   - 选择合适的图片尺寸，比如：让设计师按照xxhdpi规格来设计和切图，别小View用大图，那就浪费了；
   - 尽量使用drawable xml、color、.9.png来代替图片；

2. Native库的精简，比如：

   - 把不支持的CPU架构的Native库都移除，比如：对于一般的手机APP来讲，x86、x86_64、mips这些都可以移除

3. 减少语言支持

   - v7包中支持的语言有80种，但一般APP只在一个或者少数几个国家发布，所以只要留下相应国家的语言支持即可，这个在build.gradle中配置APP支持的语言即可，这样大概减少5M

     ```groovy
     defaultConfig {
         resConfigs "zh-rCN", "zh-rHK", "zh-rTW", "en"
     }
     ```

4. 资源名混淆

   - 使用微信开源的AndResGuard将资源名重命名为简短的名称，并最后使用7zip打包进一步减小APK

     ```groovy
     gradle resguard[buildType][productFlavor]
     ```

   - **原理概述**：apk包中有一个resources.arsc文件，该文件保存着apk中所有资源id与资源路径的映射关系，但由于资源路径、资源命名过长，导致resources.arsc文件较大，如果将过长的命名改的简短些，就可以降低该文件的大小，从而达到精简apk的目的

   - **保留mapping文件**：跟代码混淆一样，会生成源资源文件名 和 混淆后的资源文件名的 mapping文件，该文件还是有用的，比如app如有接入热修复框架，那么需要热修复某资源的时候，就要将该资源命名为混淆后的名称

## 总结

APK精简分为代码和资源两个方面，对于整个APK来讲，资源精简的效果是最明显的，属于事半功倍类型，但代码精简效果就差了很多，属于出力不讨好类型，但对于个人的代码重构优化能力的提升还是很有帮助的。